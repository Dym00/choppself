<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChoppSelf - Sistema de Autoatendimento</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>SelfChopp</h1>
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">C</div>
                <div>
                    <div>Cartão Ativo</div>
                    <div class="saldo-value" id="header-saldo">R$ 50,00</div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="tabs">
                <div class="tab active" data-tab="inicio">Início</div>
                <div class="tab" data-tab="cervejas">Cervejas</div>
                <div class="tab" data-tab="cartao">Cartão de Consumo</div>
                <div class="tab" data-tab="historico">Histórico</div>
            </div>
            <div class="tab-content active" id="inicio">
                <div class="card-title">Bem-vindo ao SelfChopp</div>
                <div class="user-profile-container">
                    <div class="infos_pessoais">
                        <div class="infos_content">
                            <h3>Informações Pessoais</h3>
                            <p><strong>CPF:</strong> <span id="user-cpf">123.456.789-01</span></p>
                            <p><strong>Nome:</strong> <span id="user-name">Marcos</span></p>
                            <p><strong>Data de Nascimento:</strong> <span id="user-birth-date">15/03/1985</span></p>
                            <p><strong>Email:</strong> <span id="user-email">marcos@email.com</span></p>
                            <p><strong>Telefone:</strong> <span id="user-phone">(11) 98765-4321</span></p>
                            <p><strong>Data de Cadastro:</strong> <span id="user-register-date">10/01/2025</span></p>
                            <div class="entrada-cliente">
                                <h4>Informações da Sessão Atual</h4>
                                <p><strong>Entrada:</strong> <span id="data-entrada">15/05/2025 19:45</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="rfid-card">
                        <div class="card-content">
                            <div class="card-chip"></div>
                            <div>
                                <div class="card-number" id="card-number">Cartão Nº 5432</div>
                                <div class="card-name">Uso interno - SelfChopp</div>
                                <div class="card-expiry">Utilize e devolva ao final</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="saldo-display">
                    <div class="saldo-label">Saldo do Cartão</div>
                    <div class="saldo-value" id="main-saldo">R$ 50,00</div>
                </div>
                <div class="debito-display">
                    <div class="debito-label">Consumo Pendente</div>
                    <div class="debito-value" id="debito-value">R$ 0,00</div>
                </div>
                <div id="card-actions" style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                </div>
            </div>
            <div class="tab-content" id="cervejas">
                <div class="card-title">Cervejas Disponíveis</div>
                <div class="chopp-grid">
                    <div class="chopp-card">
                        <div class="chopp-img">
                            <img src="https://cdn-icons-png.flaticon.com/512/2738/2738730.png" alt="Chopp Pilsen">
                        </div>
                        <div class="chopp-info">
                            <div class="chopp-title">Chopp Pilsen</div>
                            <div class="chopp-desc">Cerveja leve e refrescante</div>
                            <div class="chopp-price">R$ 12,00</div>
                        </div>
                    </div>
                    <div class="chopp-card">
                        <div class="chopp-img">
                            <img src="https://cdn-icons-png.flaticon.com/512/2738/2738730.png" alt="Chopp IPA">
                        </div>
                        <div class="chopp-info">
                            <div class="chopp-title">Chopp IPA</div>
                            <div class="chopp-desc">Cerveja amarga e aromática</div>
                            <div class="chopp-price">R$ 15,00</div>
                        </div>
                    </div>
                    <div class="chopp-card">
                        <div class="chopp-img">
                            <img src="https://cdn-icons-png.flaticon.com/512/2738/2738730.png" alt="Chopp Weiss">
                        </div>
                        <div class="chopp-info">
                            <div class="chopp-title">Chopp Weiss</div>
                            <div class="chopp-desc">Cerveja de trigo suave</div>
                            <div class="chopp-price">R$ 14,00</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="cartao">
                <div class="card-title">Cartão de Consumo</div>
                <div class="rfid-card">
                    <div class="card-content">
                        <div class="card-chip"></div>
                        <div>
                            <div class="card-number" id="card-number-2">Cartão Nº 5432</div>
                            <div class="card-name">Uso interno - ChoppSelf</div>
                            <div class="card-expiry">Utilize e devolva ao final</div>
                        </div>
                    </div>
                </div>
                <div class="saldo-display">
                    <div class="saldo-label">Saldo do Cartão</div>
                    <div class="saldo-value" id="card-tab-saldo">R$ 50,00</div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px; max-width: 400px; margin: 0 auto;">
                    <button class="btn" onclick="openRechargeModal()">Recarregar Cartão</button>
                    <button class="btn btn-outline">Transferir Saldo</button>
                    <button class="btn btn-outline">Bloquear Cartão</button>
                </div>
            </div>
            <div class="tab-content" id="historico">
                <div class="card-title">Histórico de Consumo</div>
                <div class="history-list">
                    <div class="history-item">
                        <div class="history-details">
                            <div class="history-date">15/05/2025 20:15</div>
                            <div class="history-title">Chopp Pilsen - 500ml</div>
                        </div>
                        <div class="history-price">R$ 12,00</div>
                    </div>
                    <div class="history-item">
                        <div class="history-details">
                            <div class="history-date">15/05/2025 21:30</div>
                            <div class="history-title">Chopp IPA - 500ml</div>
                        </div>
                        <div class="history-price">R$ 15,00</div>
                    </div>
                </div>
            </div>
        </div>
        <div id="recharge-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Recarregar Cartão</h2>
                    <span class="close-modal" onclick="closeRechargeModal()">&times;</span>
                </div>
                <div class="flow-steps">
                    <div class="step active">
                        <div class="step-number">1</div>
                        <div class="step-label">Valor</div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-label">Pagamento</div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-label">Confirmação</div>
                    </div>
                </div>
                <div id="step-valor" class="recharge-step active">
                    <div class="form-group">
                        <label for="recharge-amount">Selecione o valor de recarga:</label>
                        <div class="amount-options">
                            <div class="amount-option" data-value="50">R$ 50,00</div>
                            <div class="amount-option" data-value="100">R$ 100,00</div>
                            <div class="amount-option" data-value="150">R$ 150,00</div>
                            <div class="amount-option" data-value="200">R$ 200,00</div>
                        </div>
                        <div class="custom-amount">
                            <label for="custom-value">Ou digite um valor personalizado:</label>
                            <div class="custom-amount-input">
                                <span class="currency-symbol">R$</span>
                                <input type="number" id="custom-value" min="10" step="5" placeholder="0,00">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="closeRechargeModal()">Cancelar</button>
                        <button class="btn" onclick="nextStep(2)" id="btn-next-step">Próximo</button>
                    </div>
                </div>
                <div id="step-pagamento" class="recharge-step">
                    <div class="form-group">
                        <label>Selecione o método de pagamento:</label>
                        <div class="payment-methods">
                            <div class="payment-method" data-method="pix">
                                <div class="payment-icon">
                                    <img src="https://cdn-icons-png.flaticon.com/512/6124/6124998.png" alt="PIX" width="50">
                                </div>
                                <div>PIX</div>
                            </div>
                            <div class="payment-method" data-method="credit">
                                <div class="payment-icon">
                                    <img src="https://cdn-icons-png.flaticon.com/512/6963/6963703.png" alt="Cartão de Crédito" width="50">
                                </div>
                                <div>Cartão de Crédito</div>
                            </div>
                            <div class="payment-method" data-method="debit">
                                <div class="payment-icon">
                                    <img src="https://cdn-icons-png.flaticon.com/512/4021/4021708.png" alt="Cartão de Débito" width="50">
                                </div>
                                <div>Cartão de Débito</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="prevStep(1)">Voltar</button>
                        <button class="btn" onclick="nextStep(3)" id="btn-payment-next" disabled>Próximo</button>
                    </div>
                </div>
                <div id="step-confirmacao" class="recharge-step">
                    <div class="confirmation-details">
                        <h3>Confirmar Recarga</h3>
                        <div class="confirmation-item">
                            <div class="confirmation-label">Valor da Recarga:</div>
                            <div class="confirmation-value" id="confirm-value">R$ 50,00</div>
                        </div>
                        <div class="confirmation-item">
                            <div class="confirmation-label">Método de Pagamento:</div>
                            <div class="confirmation-value" id="confirm-method">PIX</div>
                        </div>
                        <div class="confirmation-item total">
                            <div class="confirmation-label">Total a Pagar:</div>
                            <div class="confirmation-value" id="confirm-total">R$ 50,00</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="prevStep(2)">Voltar</button>
                        <button class="btn btn-success" onclick="confirmRecharge()">Confirmar Pagamento</button>
                    </div>
                </div>
                <div id="processing-payment" class="recharge-step">
                    <div class="processing-container">
                        <div class="spinner"></div>
                        <p>Processando pagamento...</p>
                        <p>Por favor, aguarde.</p>
                    </div>
                </div>
                <div id="payment-success" class="recharge-step">
                    <div class="success-container">
                        <div class="success-icon">✓</div>
                        <h3>Pagamento Confirmado!</h3>
                        <p>Seu cartão foi recarregado com sucesso.</p>
                        <div class="new-balance">
                            <div>Novo Saldo:</div>
                            <div class="new-balance-value" id="new-balance-value">R$ 100,00</div>
                        </div>
                        <button class="btn" onclick="closeRechargeModal()">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="loading" class="loading">
            <div class="spinner"></div>
        </div>
    </div>
    <script>
        let selectedAmount = 0;
        let selectedPaymentMethod = '';
        let currentStep = 1;
        let cardData = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadCardData();
            setupTabs();
            setupRechargeModal();
        });

        function loadCardData() {
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';
            fetch('/api/card-data')
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        cardData = result.data;
                        updateUIWithCardData(cardData);
                    } else {
                        console.error('Erro ao carregar dados do cartão:', result.message);
                        window.location.href = '/card-reader';
                    }
                    loading.style.display = 'none';
                })
                .catch(error => {
                    console.error('Erro:', error);
                    loading.style.display = 'none';
                    window.location.href = '/card-reader';
                });
        }

        function updateUIWithCardData(data) {
            if (data.name) {
                document.getElementById('user-avatar').textContent = data.name.charAt(0);
                document.getElementById('user-name').textContent = data.name;
            }
            
            // Atualizar CPF
            if (data.cpf) {
                // Formatar CPF: XXX.XXX.XXX-XX
                const cpfFormatado = data.cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
                document.getElementById('user-cpf').textContent = cpfFormatado;
            }
            
            // Atualizar data de nascimento
            if (data.birth_date) {
                const birthDate = new Date(data.birth_date);
                const dia = String(birthDate.getDate()).padStart(2, '0');
                const mes = String(birthDate.getMonth() + 1).padStart(2, '0');
                const ano = birthDate.getFullYear();
                document.getElementById('user-birth-date').textContent = `${dia}/${mes}/${ano}`;
            }
            
            if (data.email) document.getElementById('user-email').textContent = data.email;
            if (data.phone) document.getElementById('user-phone').textContent = data.phone;

            const cardNumberElements = document.querySelectorAll('.card-number');
            cardNumberElements.forEach(el => {
                el.textContent = `Cartão Nº ${data.id}`;
            });

            const saldoElements = document.querySelectorAll('.saldo-value');
            saldoElements.forEach(el => {
                el.textContent = `R$ ${data.balance.toFixed(2).replace('.', ',')}`;
            });

            document.getElementById('debito-value').textContent = `R$ ${data.pending.toFixed(2).replace('.', ',')}`;

            if (data.entry_date) {
                const date = new Date(data.entry_date);
                const dia = String(date.getDate()).padStart(2, '0');
                const mes = String(date.getMonth() + 1).padStart(2, '0');
                const ano = date.getFullYear();
                const horas = String(date.getHours()).padStart(2, '0');
                const minutos = String(date.getMinutes()).padStart(2, '0');
                const dataFormatada = `${dia}/${mes}/${ano} ${horas}:${minutos}`;
                document.getElementById('data-entrada').textContent = dataFormatada;
            }
            
            // Adicionar data de cadastro (usando a data atual como exemplo)
            const today = new Date();
            const dia = String(today.getDate()).padStart(2, '0');
            const mes = String(today.getMonth() + 1).padStart(2, '0');
            const ano = today.getFullYear();
            document.getElementById('user-register-date').textContent = `${dia}/${mes}/${ano}`;

            updateCardActions(data.type);
        }

        function updateCardActions(cardType) {
            const actionsContainer = document.getElementById('card-actions');
            actionsContainer.innerHTML = '';
            if (cardType === 'pre') {
                actionsContainer.innerHTML = `
                <button class="btn" onclick="openRechargeModal()">Recarregar Cartão</button>
                <button class="btn btn-outline" onclick="changeTab('cervejas')">Ver Cervejas</button>
                <button class="btn btn-outline" onclick="encerrarSessao()">Encerrar</button>
                <button class="btn btn-outline" onclick="mudarTipo()">Mudar Tipo</button>
                `;
            } else {
                actionsContainer.innerHTML = `
                <button class="btn" onclick="confirmarPagamento()">Confirmar Pagamento</button>
                <button class="btn btn-outline" onclick="changeTab('cervejas')">Ver Cervejas</button>
                <button class="btn btn-outline" onclick="encerrarSessao()">Encerrar</button>
                <button class="btn btn-outline" onclick="mudarTipo()">Mudar Tipo</button>
                `;
            }
        }

        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    changeTab(tabName);
                });
            });
        }

        function changeTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function setupRechargeModal() {
            document.querySelectorAll('.amount-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.amount-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    selectedAmount = parseFloat(this.getAttribute('data-value'));
                    document.getElementById('custom-value').value = '';
                });
            });

            document.getElementById('custom-value').addEventListener('input', function() {
                document.querySelectorAll('.amount-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                selectedAmount = parseFloat(this.value) || 0;
            });

            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', function() {
                    document.querySelectorAll('.payment-method').forEach(m => {
                        m.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    selectedPaymentMethod = this.getAttribute('data-method');
                    document.getElementById('btn-payment-next').disabled = false;
                });
            });

            window.addEventListener('click', function(event) {
                const modal = document.getElementById('recharge-modal');
                if (event.target === modal) {
                    closeRechargeModal();
                }
            });
        }

        function openRechargeModal() {
            document.getElementById('recharge-modal').classList.add('active');
            resetModalState();
        }

        function closeRechargeModal() {
            document.getElementById('recharge-modal').classList.remove('active');
        }

        function resetModalState() {
            selectedAmount = 0;
            selectedPaymentMethod = '';
            currentStep = 1;
            document.querySelectorAll('.amount-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelectorAll('.payment-method').forEach(method => {
                method.classList.remove('selected');
            });
            document.getElementById('custom-value').value = '';
            document.querySelectorAll('.recharge-step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById('step-valor').classList.add('active');
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
                step.classList.remove('completed');
            });
            document.querySelectorAll('.step')[0].classList.add('active');
            document.getElementById('btn-payment-next').disabled = true;
        }

        function nextStep(step) {
            if (step === 2) {
                if (selectedAmount <= 0) {
                    alert('Por favor, selecione um valor para recarga.');
                    return;
                }
            }
            currentStep = step;
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                stepEl.classList.remove('active');
                if (index + 1 < step) {
                    stepEl.classList.add('completed');
                } else if (index + 1 === step) {
                    stepEl.classList.add('active');
                }
            });
            document.querySelectorAll('.recharge-step').forEach(stepContent => {
                stepContent.classList.remove('active');
            });
            if (step === 2) {
                document.getElementById('step-pagamento').classList.add('active');
            } else if (step === 3) {
                document.getElementById('confirm-value').textContent = `R$ ${selectedAmount.toFixed(2).replace('.', ',')}`;
                let methodText = '';
                switch (selectedPaymentMethod) {
                    case 'pix':
                        methodText = 'PIX';
                        break;
                    case 'credit':
                        methodText = 'Cartão de Crédito';
                        break;
                    case 'debit':
                        methodText = 'Cartão de Débito';
                        break;
                }
                document.getElementById('confirm-method').textContent = methodText;
                document.getElementById('confirm-total').textContent = `R$ ${selectedAmount.toFixed(2).replace('.', ',')}`;
                document.getElementById('step-confirmacao').classList.add('active');
            }
        }

        function prevStep(step) {
            nextStep(step);
        }

        function confirmRecharge() {
            document.querySelectorAll('.recharge-step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById('processing-payment').classList.add('active');
            fetch('/api/recharge-card', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    amount: selectedAmount
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('new-balance-value').textContent = `R$ ${data.new_balance.toFixed(2).replace('.', ',')}`;
                        const saldoElements = document.querySelectorAll('.saldo-value');
                        saldoElements.forEach(el => {
                            el.textContent = `R$ ${data.new_balance.toFixed(2).replace('.', ',')}`;
                        });
                        document.querySelectorAll('.recharge-step').forEach(step => {
                            step.classList.remove('active');
                        });
                        document.getElementById('payment-success').classList.add('active');
                        cardData.balance = data.new_balance;
                    } else {
                        alert(`Erro: ${data.message}`);
                        closeRechargeModal();
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao processar pagamento. Tente novamente.');
                    closeRechargeModal();
                });
        }

        function confirmarPagamento() {
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';
            fetch('/api/confirm-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('debito-value').textContent = 'R$ 0,00';
                        cardData.pending = 0.00;
                        alert('Pagamento confirmado com sucesso!');
                    } else {
                        alert(`Erro: ${data.message}`);
                    }
                    loading.style.display = 'none';
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao confirmar pagamento. Tente novamente.');
                    loading.style.display = 'none';
                });
        }

        function encerrarSessao() {
            if (confirm('Deseja realmente encerrar a sessão?')) {
                const loading = document.getElementById('loading');
                loading.style.display = 'flex';
                fetch('/api/end-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = '/card-reader';
                        } else {
                            alert(`Erro: ${data.message}`);
                            loading.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Erro:', error);
                        alert('Erro ao encerrar sessão. Tente novamente.');
                        loading.style.display = 'none';
                    });
            }
        }

        function mudarTipo() {
            const novoTipo = cardData.type === 'pre' ? 'pós-pago' : 'pré-pago';
            if (confirm(`Deseja mudar para cartão ${novoTipo}?`)) {
                const loading = document.getElementById('loading');
                loading.style.display = 'flex';
                fetch('/api/change-card-type', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            cardData.type = data.new_type;
                            updateCardActions(data.new_type);
                            alert(`Tipo de cartão alterado para ${novoTipo} com sucesso!`);
                        } else {
                            alert(`Erro: ${data.message}`);
                        }
                        loading.style.display = 'none';
                    })
                    .catch(error => {
                        console.error('Erro:', error);
                        alert('Erro ao mudar tipo de cartão. Tente novamente.');
                        loading.style.display = 'none';
                    });
            }
        }
    </script>
</body>

</html>